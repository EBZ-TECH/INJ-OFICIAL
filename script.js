/* eslint-env browser */

(function () {
    var translations = {
        "pt-BR": {
            "nav.toggle": "Abrir menu",
            "nav.home": "Início",
            "nav.about": "Quem Somos",
            "nav.ourBeliefs": "Em que acreditamos",
            "nav.nationalBoard": "Diretoria Nacional",
            "nav.departments": "Departamentos",
            "nav.donation": "Doação",
            "nav.regions": "Regiões",
            "nav.regionSouth": "Região Sur",
            "nav.regionNorth": "Região Norte",
            "nav.headquarters": "Sedes",
            "nav.content": "Conteúdo",
            "page.beliefs": "Em que acreditamos",
            "page.national": "Diretoria Nacional",
            "page.departments": "Departamentos",
            "page.headquarters": "Sedes",
            "page.content": "Conteúdo",
            "page.donation": "Doação",
            "banner.construction": "Em Construção",
            "stats.congregations": "Congregações",
            "stats.founding": "Ano de fundação",
            "stats.baptized": "Batizados",
            "mission.title": "Missão",
            "mission.text": "Ser uma igreja integral com projeção missionária para prestar o serviço aos seus membros e à comunidade em geral, capaz de enfrentar os desafios impostos por sua geração. Tornando-se um instrumento nas mãos do Senhor para cumprir a Sua obra e estender o Reino de Deus.",
            "vision.title": "Visão",
            "vision.text": "Cumprir com a Grande Comissão, MARCOS 16:15 utilizando todos os métodos e estratégias para a expansão do Reino de Deus e da consolidação da obra do Senhor, no âmbito das suas funções bíblicas às quais são: Adoração, Evangelismo, Discipulado, Comunhão e Ministério.",
            "what.script": "Que",
            "what.title": "Fazemos",
            "cards.children.title": "Crianças",
            "cards.youth.title": "Jovens",
            "cards.ladies.title": "Damas D",
            "cards.description": "Descrição de que fazemos curta. Descripción de que hacemos corta. Descripción de que hacemos corta. Descripción de que hacemos corta.",
            "carousel.prev": "Anterior",
            "carousel.next": "Próximo",
            "map.title": "Encontre-nos",
            "map.subtitle": "Nossa sede principal da INJ",
            "map.iframeLabel": "Mapa satelital da sede principal em R. Trevo do Mato 199, São Paulo",
            "map.overlayLabel": "Abrir o mapa no Google Maps",
            "footer.contact": "Fale Conosco",
            "footer.social": "Siga-nos",
            "footer.copy": "© 2025 INJ | Desenvolvido pelo EBZ.TECH"
        },
        "es-CO": {
            "nav.toggle": "Abrir menú",
            "nav.home": "Inicio",
            "nav.about": "Quiénes somos",
            "nav.ourBeliefs": "En qué creemos",
            "nav.nationalBoard": "Directiva Nacional",
            "nav.departments": "Departamentos",
            "nav.donation": "Donación",
            "nav.regions": "Regiones",
            "nav.regionSouth": "Región Sur",
            "nav.regionNorth": "Región Norte",
            "nav.headquarters": "Sedes",
            "nav.content": "Contenido",
            "page.beliefs": "En qué creemos",
            "page.national": "Directiva Nacional",
            "page.departments": "Departamentos",
            "page.headquarters": "Sedes",
            "page.content": "Contenido",
            "page.donation": "Donación",
            "banner.construction": "En construcción",
            "stats.congregations": "Congregaciones",
            "stats.founding": "Año de fundación",
            "stats.baptized": "Bautizados",
            "mission.title": "Misión",
            "mission.text": "Ser una iglesia integral con proyección misionera para servir a sus miembros y a la comunidad en general, capaz de enfrentar los desafíos de su generación. Convertirse en un instrumento en las manos del Señor para cumplir Su obra y extender el Reino de Dios.",
            "vision.title": "Visión",
            "vision.text": "Cumplir con la Gran Comisión, MARCOS 16:15, utilizando todos los métodos y estrategias para la expansión del Reino de Dios y la consolidación de la obra del Señor en sus funciones bíblicas: Adoración, Evangelismo, Discipulado, Comunión y Ministerio.",
            "what.script": "Qué",
            "what.title": "Hacemos",
            "cards.children.title": "Niños",
            "cards.youth.title": "Jóvenes",
            "cards.ladies.title": "Damas",
            "cards.description": "Descripción breve de lo que hacemos. Descripción breve de lo que hacemos. Descripción breve de lo que hacemos. Descripción breve de lo que hacemos.",
            "carousel.prev": "Anterior",
            "carousel.next": "Siguiente",
            "map.title": "Encuéntranos",
            "map.subtitle": "Nuestra sede principal de la INJ",
            "map.iframeLabel": "Mapa satelital de la sede principal en R. Trevo do Mato 199, São Paulo",
            "map.overlayLabel": "Abrir el mapa en Google Maps",
            "footer.contact": "Contáctanos",
            "footer.social": "Síguenos",
            "footer.copy": "© 2025 INJ | Diseñado por EBZ.TECH"
        },
        "en-US": {
            "nav.toggle": "Open menu",
            "nav.home": "Home",
            "nav.about": "Who We Are",
            "nav.ourBeliefs": "What We Believe In",
            "nav.nationalBoard": "National Board",
            "nav.departments": "Departments",
            "nav.donation": "Donation",
            "nav.regions": "Regions",
            "nav.regionSouth": "Southern Region",
            "nav.regionNorth": "Northern Region",
            "nav.headquarters": "Campuses",
            "nav.content": "Resources",
            "page.beliefs": "What We Believe In",
            "page.national": "National Board",
            "page.departments": "Departments",
            "page.headquarters": "Campuses",
            "page.content": "Resources",
            "page.donation": "Donation",
            "banner.construction": "Under Construction",
            "stats.congregations": "Congregations",
            "stats.founding": "Year Founded",
            "stats.baptized": "Baptized Members",
            "mission.title": "Mission",
            "mission.text": "To be a holistic church with missionary vision, serving our members and the community at large while facing the challenges of our generation. We strive to be an instrument in the Lord's hands to fulfill His work and expand the Kingdom of God.",
            "vision.title": "Vision",
            "vision.text": "To fulfill the Great Commission, MARK 16:15, using every method and strategy to expand the Kingdom of God and consolidate the Lord's work through its biblical functions: Worship, Evangelism, Discipleship, Fellowship, and Ministry.",
            "what.script": "What",
            "what.title": "We Do",
            "cards.children.title": "Children",
            "cards.youth.title": "Youth",
            "cards.ladies.title": "Ladies",
            "cards.description": "Short description of what we do. Short description of what we do. Short description of what we do. Short description of what we do.",
            "carousel.prev": "Previous",
            "carousel.next": "Next",
            "map.title": "Find Us",
            "map.subtitle": "Our main INJ campus",
            "map.iframeLabel": "Satellite map of the main campus at R. Trevo do Mato 199, São Paulo",
            "map.overlayLabel": "Open the map in Google Maps",
            "footer.contact": "Contact Us",
            "footer.social": "Follow us",
            "footer.copy": "© 2025 INJ | Designed by EBZ.TECH"
        }
    };

    var menuToggle = document.querySelector(".menu-toggle");
    var mainNav = document.querySelector(".main-nav");
    var navLinks = Array.prototype.slice.call(document.querySelectorAll(".main-nav a"));
    var languageSwitcher = document.querySelector(".language-switcher");

    function applyTranslations(lang) {
        var dict = translations[lang] || translations["pt-BR"];
        var textNodes = document.querySelectorAll("[data-i18n]");
        textNodes.forEach(function (node) {
            // Skip elements that have children (like menu-toggle with spans) or are buttons with specific content
            if (node.children.length > 0 || (node.tagName === "BUTTON" && (node.classList.contains("menu-toggle") || node.classList.contains("carousel-control")))) {
                return;
            }
            var key = node.getAttribute("data-i18n");
            if (dict[key]) {
                node.textContent = dict[key];
            }
        });

        var attrNodes = document.querySelectorAll("[data-i18n-attr]");
        attrNodes.forEach(function (node) {
            var attr = node.getAttribute("data-i18n-attr");
            // Check for data-i18n-key first, then fall back to data-i18n
            var key = node.getAttribute("data-i18n-key") || node.getAttribute("data-i18n");
            if (dict[key]) {
                node.setAttribute(attr, dict[key]);
            }
        });

        if (lang) {
            document.documentElement.setAttribute("lang", lang);
        }
    }

    if (menuToggle) {
        menuToggle.addEventListener("click", function () {
            if (mainNav) {
                mainNav.classList.toggle("open");
            }
            menuToggle.classList.toggle("active");
        });
    }

    for (var i = 0; i < navLinks.length; i += 1) {
        navLinks[i].addEventListener("click", function () {
            if (mainNav) {
                mainNav.classList.remove("open");
            }
            if (menuToggle) {
                menuToggle.classList.remove("active");
            }
            if (dropdownParent) {
                dropdownParent.classList.remove("open");
            }
        });
    }

    var dropdownParent = document.querySelector(".has-dropdown");
    var dropdownToggle = dropdownParent ? dropdownParent.querySelector("a") : null;

    function closeDropdownOnMobile() {
        if (!dropdownParent) {
            return;
        }
        dropdownParent.classList.remove("open");
    }

    function toggleDropdownOnMobile(event) {
        if (!dropdownParent || !dropdownToggle) {
            return;
        }
        if (window.innerWidth <= 900) {
            event.preventDefault();
            dropdownParent.classList.toggle("open");
        }
    }

    if (dropdownToggle) {
        dropdownToggle.addEventListener("click", toggleDropdownOnMobile);
    }

    document.addEventListener("click", function (event) {
        if (!dropdownParent) {
            return;
        }
        if (window.innerWidth <= 900 && !dropdownParent.contains(event.target)) {
            closeDropdownOnMobile();
        }
    });

    window.addEventListener("resize", function () {
        if (window.innerWidth > 900) {
            closeDropdownOnMobile();
        }
    });

    // Intersection Observer for scroll animations
    var animatedSelectors = [
        ".mission",
        ".vision",
        ".mission-gallery img",
        ".vision-gallery img",
        ".ministry-card",
        ".map-frame",
        ".footer-top"
    ];

    var statCards = document.querySelectorAll(".stat-card");
    var statValues = document.querySelectorAll(".stat-card .stat-value");

    function prepareStatValue(el) {
        var rawText = (el.textContent || "").trim();
        var prefixMatch = rawText.match(/^[^\d-]*/);
        var suffixMatch = rawText.match(/[^\d]*$/);
        var prefix = prefixMatch ? prefixMatch[0] : "";
        var suffix = suffixMatch ? suffixMatch[0] : "";
        el.dataset.prefix = prefix;
        el.dataset.suffix = suffix;
        el.textContent = prefix + "0" + suffix;
    }

    for (var sv = 0; sv < statValues.length; sv += 1) {
        prepareStatValue(statValues[sv]);
    }

    function animateStatValue(el) {
        if (!el) {
            return;
        }
        var statValue = el.querySelector(".stat-value");
        if (!statValue || statValue.dataset.animating === "true") {
            return;
        }

        var target = Number(statValue.getAttribute("data-target")) || 0;
        var duration = Number(statValue.getAttribute("data-duration")) || 1500;
        var start = null;

        var prefix = statValue.dataset.prefix || "";
        var suffix = statValue.dataset.suffix || "";

        statValue.dataset.animating = "true";

        function step(timestamp) {
            if (!start) {
                start = timestamp;
            }
            var progress = Math.min((timestamp - start) / duration, 1);
            var currentValue = Math.round(progress * target);
            statValue.textContent = prefix + currentValue.toString() + suffix;
            if (progress < 1) {
                statValue._rafId = window.requestAnimationFrame(step);
            } else {
                statValue.dataset.animating = "false";
            }
        }

        if (statValue._rafId) {
            window.cancelAnimationFrame(statValue._rafId);
        }

        statValue._rafId = window.requestAnimationFrame(step);
    }

    function resetStatValue(el) {
        var statValue = el.querySelector(".stat-value");
        if (!statValue) {
            return;
        }
        if (statValue._rafId) {
            window.cancelAnimationFrame(statValue._rafId);
            statValue._rafId = null;
        }
        statValue.dataset.animating = "false";
        var prefix = statValue.dataset.prefix || "";
        var suffix = statValue.dataset.suffix || "";
        statValue.textContent = prefix + "0" + suffix;
    }

    var statsObserver = typeof IntersectionObserver !== "undefined"
        ? new IntersectionObserver(function (entries) {
            for (var sc = 0; sc < entries.length; sc += 1) {
                var entry = entries[sc];
                if (entry.isIntersecting) {
                    entry.target.classList.add("visible");
                    animateStatValue(entry.target);
                } else {
                    entry.target.classList.remove("visible");
                    resetStatValue(entry.target);
                }
            }
        }, { threshold: 0.4 })
        : null;

    for (var c = 0; c < statCards.length; c += 1) {
        var statCard = statCards[c];
        statCard.classList.add("animate-on-scroll");
        if (statsObserver) {
            statsObserver.observe(statCard);
        } else {
            statCard.classList.add("visible");
            animateStatValue(statCard);
        }
    }

    var observer = typeof IntersectionObserver !== "undefined"
        ? new IntersectionObserver(function (entries) {
            for (var j = 0; j < entries.length; j += 1) {
                var entry = entries[j];
                if (entry.isIntersecting) {
                    entry.target.classList.add("visible");
                    observer.unobserve(entry.target);
                }
            }
        }, { threshold: 0.2 })
        : null;

    for (var s = 0; s < animatedSelectors.length; s += 1) {
        var elements = document.querySelectorAll(animatedSelectors[s]);
        for (var e = 0; e < elements.length; e += 1) {
            var el = elements[e];
            el.classList.add("animate-on-scroll");
            if (observer) {
                observer.observe(el);
            } else {
                el.classList.add("visible");
            }
        }
    }

    // Carousel functionality
    var track = document.querySelector(".carousel-track");
    var slides = Array.prototype.slice.call(document.querySelectorAll(".ministry-card"));
    var prevBtn = document.querySelector(".carousel-control.prev");
    var nextBtn = document.querySelector(".carousel-control.next");
    var currentIndex = 0;
    var slidesPerView = 3;
    var autoPlayInterval;

    function updateSliderPosition() {
        if (!track || slidesPerView < 1) {
            return;
        }

        var offset;
        if (slidesPerView === 1) {
            var totalSlides = slides.length || 1;
            offset = currentIndex * (100 / totalSlides);
        } else {
            offset = (100 / slidesPerView) * currentIndex;
        }
        var transformValue = "translateX(-" + offset + "%)";

        track.style.transform = transformValue;
    }

    function updateSliderMetrics() {
        var width = window.innerWidth || document.documentElement.clientWidth || 1024;
        slidesPerView = width <= 900 ? 1 : 3;
        var maxIndex = Math.max(0, slides.length - slidesPerView);
        if (currentIndex > maxIndex) {
            currentIndex = maxIndex;
        }

        if (track) {
            if (slidesPerView === 1) {
                track.style.width = slides.length * 100 + "%";
            } else {
                track.style.width = "100%";
            }
        }

        for (var sIdx = 0; sIdx < slides.length; sIdx += 1) {
            var slide = slides[sIdx];
            if (slidesPerView === 1) {
                slide.style.flex = "0 0 100%";
                slide.style.maxWidth = "min(360px, 92vw)";
                slide.style.margin = "0 auto";
            } else {
                slide.style.flex = "";
                slide.style.maxWidth = "";
                slide.style.margin = "";
            }
        }

        updateSliderPosition();
    }

    function moveSlider(direction) {
        var maxIndex = Math.max(0, slides.length - slidesPerView);
        currentIndex += direction;
        if (currentIndex < 0) {
            currentIndex = maxIndex;
        }
        if (currentIndex > maxIndex) {
            currentIndex = 0;
        }
        updateSliderPosition();
    }

    if (prevBtn) {
        prevBtn.addEventListener("click", function () {
            moveSlider(-1);
        });
    }

    if (nextBtn) {
        nextBtn.addEventListener("click", function () {
            moveSlider(1);
        });
    }

    function stopAutoPlay() {
        if (autoPlayInterval) {
            clearInterval(autoPlayInterval);
            autoPlayInterval = null;
        }
    }

    function startAutoPlay() {
        stopAutoPlay();
        autoPlayInterval = setInterval(function () {
            moveSlider(1);
        }, 6000);
    }

    if (track) {
        track.addEventListener("mouseenter", stopAutoPlay);
        track.addEventListener("mouseleave", startAutoPlay);
    }
    if (prevBtn) {
        prevBtn.addEventListener("mouseenter", stopAutoPlay);
        prevBtn.addEventListener("mouseleave", startAutoPlay);
    }
    if (nextBtn) {
        nextBtn.addEventListener("mouseenter", stopAutoPlay);
        nextBtn.addEventListener("mouseleave", startAutoPlay);
    }

    window.addEventListener("resize", updateSliderMetrics);
    window.addEventListener("orientationchange", updateSliderMetrics);

    document.addEventListener("DOMContentLoaded", function () {
        updateSliderMetrics();
        startAutoPlay();
    });

    // Active navigation state based on scroll
    var sectionAnchors = Array.prototype.slice.call(document.querySelectorAll("main section"));

    function highlightNav() {
        var scrollPos = (window.scrollY || window.pageYOffset || 0) + 160;
        for (var idx = 0; idx < sectionAnchors.length; idx += 1) {
            var section = sectionAnchors[idx];
            var id = section.getAttribute("id");
            if (!id) {
                continue;
            }
            var navLink = document.querySelector('.main-nav a[href="#' + id + '"]');
            if (!navLink) {
                continue;
            }
            if (scrollPos >= section.offsetTop && scrollPos < section.offsetTop + section.offsetHeight) {
                for (var n = 0; n < navLinks.length; n += 1) {
                    navLinks[n].classList.remove("active");
                }
                navLink.classList.add("active");
            }
        }
    }

    window.addEventListener("scroll", highlightNav);
    window.addEventListener("load", highlightNav);

    if (languageSwitcher) {
        var langButton = languageSwitcher.querySelector(".language-select");
        var langMenu = languageSwitcher.querySelector(".language-menu");
        var langOptions = Array.prototype.slice.call(languageSwitcher.querySelectorAll(".language-option"));
        var langLabel = languageSwitcher.querySelector(".language-label");
        var langFlag = languageSwitcher.querySelector(".language-flag");

        function closeLanguageMenu() {
            languageSwitcher.classList.remove("open");
            if (langButton) {
                langButton.setAttribute("aria-expanded", "false");
            }
        }

        function openLanguageMenu() {
            languageSwitcher.classList.add("open");
            if (langButton) {
                langButton.setAttribute("aria-expanded", "true");
            }
        }

        function toggleLanguageMenu() {
            if (languageSwitcher.classList.contains("open")) {
                closeLanguageMenu();
            } else {
                openLanguageMenu();
            }
        }

        function storeLanguage(data) {
            try {
                localStorage.setItem("preferredLanguage", JSON.stringify(data));
            } catch (err) {
                // ignore storage errors
            }
        }

        function applyLanguage(data, shouldStore) {
            if (!data) {
                return;
            }
            if (langLabel) {
                langLabel.textContent = data.label;
            }
            if (langFlag) {
                langFlag.src = data.flag;
                langFlag.alt = data.alt;
            }
            if (langButton) {
                langButton.setAttribute("data-lang", data.lang);
            }
            langOptions.forEach(function (option) {
                if (option.dataset.lang === data.lang) {
                    option.classList.add("active");
                } else {
                    option.classList.remove("active");
                }
            });
            if (shouldStore) {
                storeLanguage(data);
            }

        applyTranslations(data.lang);
        }

        if (langButton) {
            langButton.addEventListener("click", function (event) {
                event.stopPropagation();
                toggleLanguageMenu();
            });
        }

        langOptions.forEach(function (option) {
            option.addEventListener("click", function (event) {
                event.stopPropagation();
                var data = {
                    lang: option.dataset.lang,
                    label: option.dataset.label,
                    flag: option.dataset.flag,
                    alt: option.dataset.alt
                };
                applyLanguage(data, true);
                closeLanguageMenu();
            });
        });

        document.addEventListener("click", function (event) {
            if (!languageSwitcher.contains(event.target)) {
                closeLanguageMenu();
            }
        });

        document.addEventListener("keydown", function (event) {
            if (event.key === "Escape") {
                closeLanguageMenu();
            }
        });

        var storedLanguage = null;
        try {
            storedLanguage = JSON.parse(localStorage.getItem("preferredLanguage") || "null");
        } catch (err) {
            storedLanguage = null;
        }

        if (storedLanguage && storedLanguage.lang) {
            applyLanguage(storedLanguage, false);
        } else if (langOptions.length > 0) {
            var defaultOption = langOptions[0];
            var defaultData = {
                lang: defaultOption.dataset.lang,
                label: defaultOption.dataset.label,
                flag: defaultOption.dataset.flag,
                alt: defaultOption.dataset.alt
            };
            applyLanguage(defaultData, false);
        }
    } else {
        applyTranslations("pt-BR");
    }
})();
